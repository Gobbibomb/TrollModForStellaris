namespace = rules

#	only rules.2 is actually used by PHI at this point

country_event = {
	id = rules.2
	hide_window = yes

	is_triggered_only = yes
	
	trigger = {
		is_at_war = no
		NOT = { has_global_flag = phi_border_gore_allowed }
	}
	
	immediate = {
		every_owned_planet = {
			limit = { num_pops > 1 }
			solar_system = {
				set_star_flag = connected
			}
		}
		
		every_system_within_border = {
			limit = {
				NOT = { has_star_flag = connected }
			}
			if = {
				limit = {
					any_neighbor_system = {
						exists = owner
						owner = {
							OR = {
								AND = {
									is_subject = yes
									overlord = { is_same_value = root }
								}
								is_in_federation_with = root
								root = {
									is_subject = yes
									overlord = { is_same_value = prev }
								}
							}
						}
					}
				}
				set_star_flag = connected
			}
		}
		
		while = {
			limit = {
				any_system_within_border = {
					NOT = { has_star_flag = connected }
					root = {
						any_system_within_border = {
							has_hyperlane_to = prevprev
							has_star_flag = connected
						}
					}
				}
			}
			every_system_within_border = {
				if = {
					limit = {
						any_neighbor_system = {
							has_star_flag = connected
						}
					}
					set_star_flag = connected
				}
			}
		}
		
		#rinse and repeat for gateways' connected systems
		if = {
			limit = {
				any_system_within_border = {
					OR = {
						has_megastructure = gateway_restored
						has_megastructure = gateway_final
						has_star_flag = lgate
					}
					has_star_flag = connected
				}
			}
			every_system_within_border = {
				if = {
					limit = {
						OR = {
							has_megastructure = gateway_restored
							has_megastructure = gateway_final
							AND = {
								has_star_flag = lcluster_lgate
								has_star_flag = lcluster
							}
						}
					}
					set_star_flag = connected
				}
			}
			while = {
				limit = {
					any_system_within_border = {
						NOT = { has_star_flag = connected }
						root = {
							any_system_within_border = {
								has_hyperlane_to = prevprev
								has_star_flag = connected
							}
						}
					}
				}
				every_system_within_border = {
					if = {
						limit = {
							any_neighbor_system = {
								has_star_flag = connected
							}
						}
						set_star_flag = connected
					}
				}
			}
		}
		#need connect whormole how star connected phi mod not permit this
		#to do
		#----------------------------------------
		while = {
			if = {
				limit = {
					any_system_within_border = {
						AND = {
							NOT = { has_star_flag = connected }
							has_natural_wormhole = yes
						}
						root = {
							any_system_within_border = {
								link_wormholes = prevprev
								has_star_flag = connected
							}
						}
					}
				}
				set_star_flag = connected
			}
			every_system_within_border = {
				if = {
					limit = {
						any_neighbor_system = {
							has_star_flag = connected
						}
					}
					set_star_flag = connected
				}
			}
		}
		#######################################
		#taking care of the sealed entry system
		if = {
			limit = {
				any_system_within_border = {
					has_star_flag = sealed_entry_system
					has_star_flag = connected
				}
			}
			every_system_within_border = {
				if = {
					limit = {
						has_star_flag = sealed_system
					}
					set_star_flag = connected
				}
			}
		}
		
		#removes non-connected systems from the empire territory
		every_owned_fleet = {
			limit = {
				is_ship_class = shipclass_starbase
				solar_system = {
					NOT = { has_star_flag = connected }
				}
			}
			destroy_fleet = this
		}
		
		#removes the "connected" status from every system
		every_system_within_border = {
			remove_star_flag = connected
		}
	}
}